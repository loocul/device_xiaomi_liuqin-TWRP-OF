name: PitchBlack Recovery Project Builder
on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'PBRP Manifest Branch'
        required: true
        default: 'android-12.1'
        type: choice
        options:
          - android-14.0
          - android-12.1
          - android-11.0
          - android-10.0
          - android-9.0
          - android-8.1
          - android-7.1
          - android-6.0
      DEVICE_TREE:
        description: 'Custom Recovery Tree URL'
        required: true
        default: 'https://github.com/xccxxcys/device_xiaomi_liuqin-TWRP-OF'
      DEVICE_TREE_BRANCH:
        description: 'Device Tree Branch (leave empty for "main")'
        required: false
        default: ''
      DEVICE_NAME:
        description: 'Device Codename (match PRODUCT_DEVICE)'
        required: true
        default: 'liuqin'  # ä¸é»˜è®¤è®¾å¤‡æ ‘è·¯å¾„å¯¹åº”
      DEVICE_PATH:
        description: 'Device Path (default: device/xiaomi/liuqin)'
        required: true
        default: 'device/xiaomi/liuqin'  # æ ¸å¿ƒé»˜è®¤é…ç½®
      BUILD_TARGET:
        description: 'Build Target (use "pbrp" for Android 11+)'
        required: true
        default: 'recovery'
        type: choice
        options:
          - pbrp
          - recovery
          - boot
          - vendorboot
      upload_releases:
        description: 'Upload to GitHub Releases?'
        required: true
        default: 'true'
        type: boolean

jobs:
  build:
    name: Build PBRP for ${{ inputs.DEVICE_NAME }} by ${{ github.actor }}
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    env:
      DEVICE_NAME: ${{ inputs.DEVICE_NAME }}
      DEVICE_PATH: ${{ inputs.DEVICE_PATH }}
      OUTPUT_DIR: ${{ github.workspace }}/android-recovery/out/target/product/${{ inputs.DEVICE_NAME }}
      PBRP_VERSION: "4.0"

    permissions:
      contents: write

    steps:
      - name: ğŸ“‹ Show Build Configuration
        run: |
          echo "=== PBRP Build Config ==="
          echo "Manifest Branch: ${{ inputs.MANIFEST_BRANCH }}"
          echo "Device Tree: ${{ inputs.DEVICE_TREE }} (Branch: ${{ inputs.DEVICE_TREE_BRANCH || 'main' }})"
          echo "Device: $DEVICE_NAME (Path: $DEVICE_PATH)"
          echo "Build Target: ${{ inputs.BUILD_TARGET }}"
          echo "Build Date: $BUILD_DATE"
          echo "Upload to Releases: ${{ inputs.upload_releases }}"
          echo "========================"

      - name: ğŸ§¹ Clean-up Workspace
        uses: rokibhasansagar/slimhub_actions@main
        with:
          remove-dotnet: true
          remove-android: true
          remove-haskell: true

      - name: ğŸ—ï¸ Build PitchBlack Recovery (via Official Action)
        uses: mlm-games/pitchblack-pbrp-builder-action@main
        id: build
        with:
          MANIFEST_BRANCH: ${{ inputs.MANIFEST_BRANCH }}
          DEVICE_TREE: ${{ inputs.DEVICE_TREE }}
          DEVICE_TREE_BRANCH: ${{ inputs.DEVICE_TREE_BRANCH || 'main' }}  # ç©ºå€¼é»˜è®¤main
          DEVICE_PATH: ${{ inputs.DEVICE_PATH }}
          DEVICE_NAME: ${{ inputs.DEVICE_NAME }}
          BUILD_TARGET: ${{ inputs.BUILD_TARGET }}
          CCACHE_ENABLE: true  # å¯ç”¨ccacheåŠ é€Ÿæ„å»º
          CCACHE_SIZE: "5G"

      - name: ğŸ“Š Calculate MD5 Checksums
        run: |
          set -e
          # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
          if [ ! -d "$OUTPUT_DIR" ]; then
            echo "Error: Output directory $OUTPUT_DIR not found"
            exit 1
          fi
          # æŸ¥æ‰¾å¹¶è®¡ç®—imgå’Œzipæ–‡ä»¶çš„MD5
          IMG_FILE=$(find "$OUTPUT_DIR" -name "*.img" -print -quit)
          ZIP_FILE=$(find "$OUTPUT_DIR" -name "PBRP*.zip" -print -quit)
          if [ -f "$IMG_FILE" ]; then
            echo "MD5_IMG=$(md5sum "$IMG_FILE" | cut -d ' ' -f 1)" >> $GITHUB_ENV
          fi
          if [ -f "$ZIP_FILE" ]; then
            echo "MD5_ZIP=$(md5sum "$ZIP_FILE" | cut -d ' ' -f 1)" >> $GITHUB_ENV
          fi
          # è¾“å‡ºæ–‡ä»¶åˆ—è¡¨
          echo "=== Output Files ==="
          ls -lh "$OUTPUT_DIR"/*.img "$OUTPUT_DIR"/*.zip 2>/dev/null || true

      - name: ğŸ“¤ Upload Build Artifacts (for Testing)
        uses: actions/upload-artifact@v5
        if: ${{ !inputs.upload_releases }}
        with:
          name: PBRP-${{ inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}
          path: |
            ${{ env.OUTPUT_DIR }}/*.img
            ${{ env.OUTPUT_DIR }}/*.tar
            ${{ env.OUTPUT_DIR }}/*vbmeta*
            ${{ env.OUTPUT_DIR }}/*.cpio
            ${{ env.OUTPUT_DIR }}/*.zip
          retention-days: 7  # ä¿ç•™7å¤©ï¼ŒèŠ‚çœç©ºé—´

      - name: ğŸš€ Upload to GitHub Releases
        if: ${{ inputs.upload_releases && success() }}
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.OUTPUT_DIR }}/*.img
            ${{ env.OUTPUT_DIR }}/PBRP*.zip
            ${{ env.OUTPUT_DIR }}/*vbmeta*
          name: PBRP ${{ env.PBRP_VERSION }} - ${{ inputs.DEVICE_NAME }} - ${{ env.BUILD_DATE }}
          tag_name: PBRP-${{ inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}-${{ github.run_id }}
          body: |
            ## Unofficial PBRP Build for ${{ inputs.DEVICE_NAME }}
            ### Build Information
            - **Manifest Branch**: ${{ inputs.MANIFEST_BRANCH }}
            - **Build Date**: ${{ env.BUILD_DATE }}
            - **Build Target**: ${{ inputs.BUILD_TARGET }}
            - **Device Path**: ${{ inputs.DEVICE_PATH }}

            ### Source Information
            - **Device Tree**: [${{ inputs.DEVICE_TREE_BRANCH || 'main' }}](${{ inputs.DEVICE_TREE }}/tree/${{ inputs.DEVICE_TREE_BRANCH || 'main' }})
            - **Default Device Tree**: `device/xiaomi/liuqin`

            ### Checksums
            - **Recovery Image MD5**: `${{ env.MD5_IMG || 'N/A' }}`
            - **ZIP Package MD5**: `${{ env.MD5_ZIP || 'N/A' }}`

            > Note: Automated build. Test thoroughly before flashing. Report issues with build logs if possible.
          prerelease: false
          draft: false

      - name: â±ï¸ Calculate Build Time
        if: always()
        run: |
          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          hours=$((BUILD_DURATION / 3600))
          minutes=$(((BUILD_DURATION % 3600) / 60))
          seconds=$((BUILD_DURATION % 60))
          echo "âœ… Build completed in ${hours}h ${minutes}m ${seconds}s"
          echo "BUILD_DURATION=${hours}h${minutes}m${seconds}s" >> $GITHUB_ENV

      - name: ğŸ§¹ Cleanup Workspace
        if: always()
        run: |
          rm -rf ${{ github.workspace }}/android-recovery
          df -h  # æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
