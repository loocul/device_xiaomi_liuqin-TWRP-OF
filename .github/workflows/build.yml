name: TWRP 16 Builder
on:
  workflow_dispatch:
    inputs:
      TWRP_MANIFEST_URL:
        description: "TWRP manifest url"
        required: true
        default: "https://github.com/ymdzq/manifest_twrp"
      TWRP_MANIFEST_BRANCH:
        description: "TWRP branch"
        required: true
        default: "twrp-16.0"
      DEVICE_TREE_URL:
        description: "Device tree url"
        required: true
        default: "https://github.com/loocul/device_xiaomi_liuqin-TWRP-OF"
      DEVICE_TREE_BRANCH:
        description: "Device tree branch"
        required: true
        default: "main"
      DEVICE_PATH:
        description: "Device path"
        required: true
        default: "device/xiaomi/liuqin"
      DEVICE_NAME:
        description: "Device codename"
        required: true
        default: "liuqin"
      BUILD_TARGET:
        description: "Build target partition"
        required: true
        default: "recovery"
        type: choice
        options:
          - boot
          - recovery
          - vendorboot

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      REPO_NAME: ${{ github.event.repository.name }}
      CCACHE_MAXSIZE: "5G"  

    steps:
      - name: ğŸ“‹ Show build info & Set env vars
        run: |
          # å®šä¹‰å…³é”®ç¯å¢ƒå˜é‡ï¼ˆä¿®å¤æœªå®šä¹‰é—®é¢˜ï¼‰
          echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
          echo "TWRP_VERSION=TWRP-3.7.0_16-0" >> $GITHUB_ENV  # å¯æ ¹æ®å®é™…è°ƒæ•´ç‰ˆæœ¬
          
          echo "=== Build Configuration ==="
          echo "Manifest: ${{ inputs.TWRP_MANIFEST_URL }} (${{ inputs.TWRP_MANIFEST_BRANCH }})"
          echo "Device Tree: ${{ inputs.DEVICE_TREE_URL }} (${{ inputs.DEVICE_TREE_BRANCH }})"
          echo "Device Path: ${{ inputs.DEVICE_PATH }}"
          echo "Build Target: ${{ inputs.BUILD_TARGET }}"
          echo "Build Date: ${{ env.BUILD_DATE }}"
          echo "TWRP Version: ${{ env.TWRP_VERSION }}"
          echo "=========================="

      - name: ğŸ§¹ Cleanup & Maximize space
        uses: rokibhasansagar/slimhub_actions@main
        with:
          remove-dotnet: true
          remove-android: true
          remove-haskell: true

      - name: ğŸ“¦ Setup persistent ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          create-symlink: true
          max-size: ${{ env.CCACHE_MAXSIZE }}
          key: ${{ inputs.DEVICE_NAME }}-${{ inputs.BUILD_TARGET }}-ccache
          restore-keys: |
            ${{ inputs.DEVICE_NAME }}-${{ inputs.BUILD_TARGET }}-ccache
            ${{ inputs.DEVICE_NAME }}-ccache

      - name: ğŸ Optimize zram (memory boost)
        run: |
          set -eo pipefail
          sudo apt update && sudo apt install -y zram-tools linux-modules-extra-$(uname -r)
          sudo modprobe zram
          sudo sed -i 's/^#PERCENT=50/PERCENT=95/' /etc/default/zramswap
          sudo sed -i 's/^#PRIORITY=100/PRIORITY=2000/' /etc/default/zramswap
          sudo systemctl restart zramswap
          zramctl | awk '{print "Zram Usage:", $1, $2, $3}'

      - name: ğŸ› ï¸ Setup build environment
        run: |
          set -eo pipefail
          export DEBIAN_FRONTEND=noninteractive
          sudo apt update && sudo apt upgrade -y
          sudo apt install repo git-lfs -y  # æ–°å¢git-lfsï¼ˆé¿å…å¤§æ–‡ä»¶åŒæ­¥å¤±è´¥ï¼‰
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
    
      - name: ğŸ“¥ Sync source code (fixed)
        run: |
          set -eo pipefail
          # ä¿®å¤ï¼šå»æ‰å¤šä½™åæ–œæ ï¼Œä¿ç•™åŸºç¡€å‚æ•°
          repo init \
            -u ${{ inputs.TWRP_MANIFEST_URL }} \
            -b ${{ inputs.TWRP_MANIFEST_BRANCH }} \
            --depth=1 \
            --no-repo-verify  # è·³è¿‡repoç‰ˆæœ¬éªŒè¯ï¼ˆé¿å…æ— å…³è­¦å‘Šï¼‰
          
          # æ¢å¤åŸå§‹ repo sync å‘½ä»¤ï¼Œå»é™¤é€Ÿåº¦ä¼˜åŒ–å‚æ•°
          repo sync
          echo "Source sync completed successfully"

      - name: ğŸ“± Clone device tree
        run: |
          set -eo pipefail
          # åˆ›å»ºè®¾å¤‡è·¯å¾„ï¼ˆé¿å…è·¯å¾„ä¸å­˜åœ¨æŠ¥é”™ï¼‰
          mkdir -p $(dirname ${{ inputs.DEVICE_PATH }})
          git clone \
            ${{ inputs.DEVICE_TREE_URL }} \
            -b ${{ inputs.DEVICE_TREE_BRANCH }} \
            --depth=1 \
            ${{ inputs.DEVICE_PATH }}

      - name: ğŸ“ Generate build info
        run: |
          set -eo pipefail
          BUILD_INFO="TWRP Build Info
          =================
          Version: ${{ env.TWRP_VERSION }}
          Device: ${{ inputs.DEVICE_NAME }}
          Manifest Branch: ${{ inputs.TWRP_MANIFEST_BRANCH }}
          Device Tree Branch: ${{ inputs.DEVICE_TREE_BRANCH }}
          Build Target: ${{ inputs.BUILD_TARGET }}
          Build Date: ${{ env.BUILD_DATE }}
          GitHub Run ID: ${{ github.run_id }}
          "
          echo -e "$BUILD_INFO" > INFO.txt
          echo -e "\nChange Log:" >> INFO.txt
          # è·å–è®¾å¤‡æ ‘æäº¤æ—¥å¿—ï¼ˆé¿å…æ— æ ‡ç­¾æ—¶æŠ¥é”™ï¼‰
          cd ${{ inputs.DEVICE_PATH }}
          if git describe --tags --abbrev=0 >/dev/null 2>&1; then
            LAST_TAG=$(git describe --tags --abbrev=0)
            git log --pretty=format:"- %h (%an): %s" $LAST_TAG..HEAD >> ../../INFO.txt
          else
            git log --pretty=format:"- %h (%an): %s" -n 20 >> ../../INFO.txt  # é™åˆ¶æ—¥å¿—é•¿åº¦
          fi
          cat ../../INFO.txt

      - name: ğŸ—ï¸ Build TWRP (with ccache & logs)
        run: |
          set -eo pipefail
          # åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
          source build/envsetup.sh
          # é…ç½®ccache
          export ALLOW_MISSING_DEPENDENCIES=true
          export CCACHE_DIR=$GITHUB_WORKSPACE/.ccache
          export CCACHE_EXEC=$(command -v ccache)
          export USE_CCACHE=1
          # é¢„çƒ­ccacheï¼ˆåŠ å¿«ç¼–è¯‘ï¼‰
          ccache -s
          # ä¿®å¤ï¼šTWRPæ­£ç¡®lunchæ ¼å¼ï¼ˆtwrp_è®¾å¤‡å-engï¼‰
          lunch twrp_${{ inputs.DEVICE_NAME }}-eng
          make clean
          # å¹¶è¡Œç¼–è¯‘+æ—¥å¿—æ•è·ï¼ˆä¿®å¤æ— build.logé—®é¢˜ï¼‰
          make adbd ${{ inputs.BUILD_TARGET }}image -j$(nproc --all) > build.log 2>&1
          # éªŒè¯è¾“å‡ºæ–‡ä»¶
          OUTPUT_FILE="out/target/product/${{ inputs.DEVICE_NAME }}/${{ inputs.BUILD_TARGET }}.img"
          if [ ! -f "$OUTPUT_FILE" ]; then
            echo "Error: Build failed - Output file not found"
            cat build.log  # æ‰“å°æ—¥å¿—æ–¹ä¾¿æ’æŸ¥
            exit 1
          fi
          # é‡å‘½åè¾“å‡ºæ–‡ä»¶ï¼ˆåŒ…å«å®Œæ•´ä¿¡æ¯ï¼‰
          mv "$OUTPUT_FILE" "out/target/product/${{ inputs.DEVICE_NAME }}/${{ env.TWRP_VERSION }}-${{ inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}.img"
          echo "Build completed successfully!"
          ccache -s  # æ˜¾ç¤ºccacheä½¿ç”¨æƒ…å†µ

      - name: ğŸ“¤ Upload build artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            out/target/product/${{ inputs.DEVICE_NAME }}/${{ env.TWRP_VERSION }}-${{ inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}.img
            build.log
            INFO.txt
          name: ${{ env.TWRP_VERSION }}-${{ inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}
          tag_name: ${{ env.BUILD_DATE }}-${{ inputs.DEVICE_NAME }}-${{ github.run_id }}
          body_path: INFO.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
